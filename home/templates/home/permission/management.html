{% extends "flame.html" %}
{% load django_bootstrap5 %}
{% block subtitle %}
    権限管理
{% endblock subtitle %}
{% block description %}
    スタッフ／グループ管理
{% endblock description %}
{% block breadcrumb %}
    <li class="breadcrumb-item">
        <a href="{% url 'home:index' %}">ホーム</a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">権限管理</li>
{% endblock breadcrumb %}
{% block menu_manage_permission %}
    active
{% endblock menu_manage_permission %}
{% block body %}
    <div class="card mt-3">
        <div class="card-header">
            <h1>スタッフ管理</h1>
        </div>
        <div class="card-body">
            <div class="alert alert-warning">
                この画面からはシステム管理者の権限を操作することはできません。
                「<a href="{% url 'admin:index' %}">管理サイト</a>」から行ってください。
            </div>
            <div class="text-end">
                <a href="{% url 'home:permission_register_staff' %}"
                   class="btn btn-success">
                    <i class="fa-solid fa-plus"></i>
                    スタッフ登録
                </a>
            </div>
            <div class="table-responsive text-nowrap">
                <table class="table">
                    <thead>
                        <tr>
                            <th>メールアドレス</th>
                            <th>表示名</th>
                            <th>備考</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in staff_list %}
                            <tr>
                                <td>{{ user.email }}</td>
                                <td>{{ user.display_name }}</td>
                                <td>
                                    {% if user.is_superuser %}<span class="text-danger">システム管理者</span>{% endif %}
                                </td>
                                <td>
                                    {% if user.is_superuser %}
                                        <p class="text-sm text-secondary mb-0">システム管理者は操作できません</p>
                                    {% else %}
                                        <button type="button"
                                                class="btn btn-danger btn-sm"
                                                data-bs-toggle="modal"
                                                data-bs-target="#unregister_staff_{{ user.id }}">
                                            <i class="fa-solid fa-xmark"></i>
                                            スタッフ解除
                                        </button>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- Modal: unregister_staff -->
    {% for user in staff_list %}
        <div class="modal fade"
             id="unregister_staff_{{ user.id }}"
             tabindex="-1"
             aria-labelledby="unregister_staff_{{ user.id }}_label"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="unregister_staff_{{ user.id }}_label">スタッフ解除</h1>
                        <button type="button"
                                class="btn-close"
                                data-bs-dismiss="modal"
                                aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <strong>{{ user }}</strong> さんをスタッフ解除しますか？
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">とじる</button>
                        <a href="{% url 'home:permission_unregister_staff' user.id %}"
                           class="btn btn-danger">
                            <i class="fa-solid fa-xmark"></i>
                            スタッフ解除
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
    <div class="card">
        <div class="card-header">
            <h1>グループ管理</h1>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                スタッフをグループに所属させることで権限を管理できます。
                また、システム管理者はグループに所属させなくても全権限が付与されています。
            </div>
            <div class="text-end">
                <a href="{% url 'home:permission_create_group' %}"
                   class="btn btn-success">
                    <i class="fa-solid fa-plus"></i>
                    追加
                </a>
            </div>
            <div class="table-responsive text-nowrap">
                <table class="table">
                    <thead>
                        <tr>
                            <th>名前</th>
                            <th>権限</th>
                            <th>メンバー</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for group in group_list %}
                            <tr>
                                <td>{{ group.name }}</td>
                                <td>
                                    {% for permission in group.permissions.all %}
                                        {% if not forloop.first %}<br/>{% endif %}
                                        {{ permission.name }}
                                    {% endfor %}
                                </td>
                                <td>
                                    {% for user in group.user_set.all %}
                                        {% if not forloop.first %}<br/>{% endif %}
                                        {{ user }}
                                    {% endfor %}
                                </td>
                                <td>
                                    <a href="{% url 'home:permission_update_group' group.id %}"
                                       class="btn btn-warning btn-sm">
                                        <i class="fa-solid fa-pen-to-square"></i>
                                        編集
                                    </a>
                                    <a href="{% url 'home:permission_delete_group' group.id %}"
                                       class="btn btn-danger btn-sm">
                                        <i class="fa-solid fa-xmark"></i>
                                        削除
                                    </a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock body %}
